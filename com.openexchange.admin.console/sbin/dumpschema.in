#!/bin/bash
#
#
#   @copyright Copyright (c) OX Software GmbH, Germany <info@open-xchange.com>
#   @license AGPL-3.0
#
#   This code is free software: you can redistribute it and/or modify
#   it under the terms of the GNU Affero General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU Affero General Public License for more details.
#
#   You should have received a copy of the GNU Affero General Public License
#   along with OX App Suite.  If not, see <https://www.gnu.org/licenses/agpl-3.0.txt>.
#
#   Any use of the work other than as authorized under this license or copyright law is prohibited.
#
#


OXFUNCTIONS=@oxfunctions@
OXCONFIG=@oxscriptconf@


test -f $OXFUNCTIONS || {
    echo "missing common shell functions file"
    exit 1
}

. $OXFUNCTIONS

test -f $OXCONFIG && . $OXCONFIG

ox_set_JAVA_BIN

test -z "$JAVA_OXCMD_OPTS" && JAVA_OXCMD_OPTS="-Xmx280M"

JAVA_OPTS="${JAVA_OXCMD_OPTS} \
-Djava.awt.headless=true \
-Dopenexchange.propdir=$PROPERTIESDIR"

CLASSPATH="-classpath @classpath@"

umask 066
OUTPUT="$(exec $JAVA_BIN $JAVA_OPTS $CLASSPATH com.openexchange.admin.console.schemamove.DumpSchema $@ 2>&1)"
# Expect the following response: <schema> -h <host> -P <port> -u <username> -p<password> --single-transaction > <output>
# This output can directly be fed to mysqldump

RETVAL=$?

# No parameters supplied, return output which is usage
if [ $# -eq 0 ]; then
	echo -e "$OUTPUT"
	exit 0
fi

# Return code is 0, no flag '-h' or '--help' supplied, DumpSchema exited successfully, feed output to mysqldump, 
# otherwise return output and the exit code of the java tool
if [ $RETVAL -eq 0 ] && [ $1 != "-h" ] && [ $1 != "--help" ]; then
        schema="$(echo $OUTPUT | awk '{print $1}')"
        echo -n "Dumping schema '$schema'..."
        dump="mysqldump $OUTPUT"
        eval $dump
        echo -e " done."
else
        echo -e "$OUTPUT"
        exit $RETVAL
fi
